{% extends "accounts/base.html" %}

{% block title %}Liste des Postes - RH System{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-900">Postes Ouverts</h1>
    </div>

    <!-- Filtres et Tri -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 bg-gray-50 p-4 rounded-lg">
        <div>
            <label for="filterInput" class="block text-sm font-medium text-gray-700">Filtrer par mot-clé</label>
            <input type="text" id="filterInput" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm" placeholder="e.g., Développeur, Paris...">
        </div>
        <div>
            <label for="filterContract" class="block text-sm font-medium text-gray-700">Type de contrat</label>
            <select id="filterContract" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm">
                <option value="">Tous les contrats</option>
                <option value="CDI">CDI</option>
                <option value="CDD">CDD</option>
                <option value="Alternance">Alternance</option>
            </select>
        </div>
        <div>
            <label for="sortSelect" class="block text-sm font-medium text-gray-700">Trier par</label>
            <select id="sortSelect" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm">
                <option value="date-desc">Plus récents d'abord</option>
                <option value="date-asc">Plus anciens d'abord</option>
                <option value="title-asc">Titre (A-Z)</option>
                <option value="title-desc">Titre (Z-A)</option>
            </select>
        </div>
    </div>

    <!-- Liste des Postes -->
    <div id="posteList" class="grid grid-cols-1 gap-6">
        {% for poste in postes %}
        <a href="{% url 'recruitment:poste_detail' poste.id %}" class="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow duration-300 block" data-contract="{{ poste.type_contrat }}" data-date="{{ poste.date_publication|date:'Y-m-d' }}">
            <div class="flex justify-between items-start">
                <div>
                    <h2 class="text-xl font-semibold text-gray-800">{{ poste.titre }}</h2>
                    <p class="text-sm text-gray-500 mt-1">Type de contrat : {{ poste.get_type_contrat_display }}</p>
                </div>
                <span class="text-sm text-gray-500">{{ poste.date_publication|timesince }}</span>
            </div>
            <p class="text-gray-600 mt-4">{{ poste.description|truncatewords:40 }}</p>
        </a>
        {% empty %}
        <div class="text-center py-12">
            <p class="text-lg text-gray-600">Aucun poste n'est actuellement disponible.</p>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const filterInput = document.getElementById('filterInput');
    const filterContract = document.getElementById('filterContract');
    const sortSelect = document.getElementById('sortSelect');
    const posteList = document.getElementById('posteList');
    const originalPostes = Array.from(posteList.querySelectorAll('[data-contract]'));

    function filterAndSort() {
        const filterText = filterInput.value.toLowerCase();
        const filterContractValue = filterContract.value;
        const sortValue = sortSelect.value;

        // 1. Filtrer
        const filteredPostes = originalPostes.filter(poste => {
            const title = poste.querySelector('h2').textContent.toLowerCase();
            const description = poste.querySelector('p').textContent.toLowerCase();
            const contract = poste.dataset.contract;

            const textMatch = title.includes(filterText) || description.includes(filterText);
            const contractMatch = filterContractValue === '' || contract === filterContractValue;

            return textMatch && contractMatch;
        });

        // 2. Trier
        filteredPostes.sort((a, b) => {
            const titleA = a.querySelector('h2').textContent;
            const titleB = b.querySelector('h2').textContent;
            const dateA = new Date(a.dataset.date);
            const dateB = new Date(b.dataset.date);

            switch (sortValue) {
                case 'date-asc':
                    return dateA - dateB;
                case 'title-asc':
                    return titleA.localeCompare(titleB);
                case 'title-desc':
                    return titleB.localeCompare(titleA);
                case 'date-desc':
                default:
                    return dateB - dateA;
            }
        });

        // 3. Mettre à jour le DOM
        posteList.innerHTML = '';
        if (filteredPostes.length > 0) {
            filteredPostes.forEach(poste => posteList.appendChild(poste));
        } else {
            posteList.innerHTML = `<div class="text-center py-12"><p class="text-lg text-gray-600">Aucun poste ne correspond à vos critères.</p></div>`;
        }
    }

    filterInput.addEventListener('keyup', filterAndSort);
    filterContract.addEventListener('change', filterAndSort);
    sortSelect.addEventListener('change', filterAndSort);

    // Tri initial
    filterAndSort();
});
</script>
{% endblock %}